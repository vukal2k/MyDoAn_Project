@model DTO.Post

@using Microsoft.AspNet.Identity;

@{
    ViewBag.Title = Model.Title;
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .aHover:hover{
        cursor:pointer;
    }
    .thumbnail {
        padding: 0px;
    }

    .panel {
        position: relative;
        margin-top: 20px;
        border: 1px solid #000000;
        padding: 3%;
    }

        .panel > .panel-heading:after, .panel > .panel-heading:before {
            position: absolute;
            top: 11px;
            left: -16px;
            right: 100%;
            width: 0;
            height: 0;
            display: block;
            content: " ";
            border-color: transparent;
            border-style: solid solid outset;
            pointer-events: none;
        }

        .panel > .panel-heading:after {
            border-width: 7px;
            border-right-color: #f7f7f7;
            margin-top: 1px;
            margin-left: 2px;
        }

        .panel > .panel-heading:before {
            border-right-color: #ddd;
            border-width: 8px;
        }
</style>
<div class="col-12">
    <h4>@Model.Title</h4>
    <hr />
    <dl class="dl-horizontal">
        <dd>
            <div class="post-meta d-flex justify-content-end">
                <div class="date meta-last">@Model.PostedOn.ToLongDateString()</div>
            </div>
        </dd>
        <dd>
            <div class="post-meta d-flex justify-content-end">
                <div class="category"><a href="@string.Format("/Blog/GetPostByCate/{0}",Model.CategoryId)">@Model.Category.Name</a></div>
            </div>
        </dd>
        <dd style="padding-left:10%"><img src="@Model.UrlSlug" style="width:795px;height:453px" /></dd>
        <dd>
            @Html.Raw(Model.Description)
        </dd>
        @if (User.IsInRole("Admin"))
        {
            <dd>
                <a style="margin-top:10px" href="@Url.Action("Edit","Admin/PostManager",new { id = Model.PostId })">Edit</a>
            </dd>
        }
        <dd>
            <hr />
        </dd>
        <dt>
            Comment
        </dt>
        @if (Request.IsAuthenticated)
        {
            <dd>
                <textarea id="commentArea" cols="130" rows="5"></textarea>
                <button class="btn btn-success" id="submitComment">Post</button>
            </dd>
        }
        else
        {
            @Html.ActionLink("Log in to post your comment", "Login", "Account", new { returnUrl = Request.Url.PathAndQuery }, htmlAttributes: new { id = "loginLink", @class = "nav-link" })
        }
        <dd id="noiCommentDungChan">
            @foreach (var item in Model.Comments.OrderByDescending(c => c.CommentId))
            {
                <div name="commentPanel" id="@string.Format("commentPanel{0}",item.CommentId)">
                    <div class="col-sm-11">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <strong>@item.Username</strong>
                            </div>
                            <div class="panel-body">
                                @item.Content
                            </div>
                            @if (User.Identity.GetUserName().Equals(item.Username))
                            {
                                <div class="d-flex justify-content-end">
                                    <a class="aHover" onclick="DeleteComment(@item.CommentId, this)">Delete</a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </dd>
    </dl>
</div>


@section Scripts{
    <script src="~/Scripts/pagingComment.js"></script>

    <script>

    $("#submitComment").click(function () {
        $.ajax({
            url: '../../Comment/PostComment',
            type: 'POST',
            dataType: "html",
            data: {
                content: $("#commentArea").val(),
                postId:@Model.PostId,
            },
            success: function(result){
                resultModel = JSON.parse(result)
                console.log(result);
                if (resultModel != null) {
                    
                    $("#noiCommentDungChan").prepend("<div name='commentPanel' id='commentPanel" +resultModel.CommentId+"'>"+
                                                        "<div class='col-sm-11'>"+
                                                            "<div class='panel panel-default'>"+
                                                                "<div class='panel-heading'>"+
                                                                    "<strong>"+resultModel.Username+"</strong>"+
                                                                "</div>"+
                                                                "<div class='panel-body'>"+
                                                                    $("#commentArea").val()+
                                                                "</div>"+
                                                                "<div class='d-flex justify-content-end'>"+
                                                                    "<a class='aHover' onclick='DeleteComment("+resultModel.CommentId+", this)'>Delete</a>"+
                                                                "</div>"+
                                                            "</div>"+
                                                        "</div>"+
                                                    "</div>")
                    $("#commentArea").val("")
                    ResetPage();
                }
            },
            error: function (x,y,z) {
            }
        })
    })

        function DeleteComment(commentIds, btn){
        $.ajax({
            url: '@Url.Action("Delete", "Comment")',
            type: 'POST',
            dataType: 'html',
            data: {
                commentId:commentIds
            },
            success: function(r){
                console.log(r);
                if (r != "fail") {
                    $("#commentPanel" + commentIds).remove()
                    ResetPage(document.getElementById("currentPage").value);
                }
            },
            error: function (x,y,z) {
            }
        })
    }
    </script>
}